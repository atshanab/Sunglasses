<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR → Camera → Sunglasses Filter (Face Tracking)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .app { position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; }
    header, footer { padding:8px 12px; background:rgba(0,0,0,.5); backdrop-filter:blur(6px); }
    header{ display:flex; gap:8px; align-items:center; }
    #stage{ position:relative; overflow:hidden; background:#000; }
    #video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
    #canvas{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
    .controls{ display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
    button,select{ -webkit-appearance:none; appearance:none; padding:10px 14px; border-radius:999px; border:0; font-weight:600; background:#fff; color:#111; box-shadow:0 4px 16px rgba(0,0,0,.25); cursor:pointer; }
    .badge{ font-size:12px; opacity:.85; }
    .hidden{ display:none !important; }
    .hud{ position:absolute; top:8px; right:12px; font-size:12px; background:rgba(0,0,0,.5); padding:6px 8px; border-radius:8px; }
    .toast{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.65); padding:12px 16px; border-radius:12px; font-size:14px; display:none; }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1 style="font-size:16px;margin:0;">AR Sunglasses (Face Tracked)</h1>
      <div id="status" class="badge">loading…</div>
    </header>
    <div id="stage">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas"></canvas>
      <div class="hud" id="hud">—</div>
      <div class="toast" id="toast"></div>
    </div>
    <footer>
      <div class="controls">
        <button id="startBtn">Start Camera</button>
        <button id="flipBtn" class="hidden">Flip Camera</button>
        <select id="filterSelect"><option value="sunglasses">Sunglasses</option></select>
        <span class="badge">Tip: if nothing renders, ensure good lighting and face fully in frame.</span>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/vision_bundle_mediapipe.js" crossorigin="anonymous"></script>
  <script>
  (function(){
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const flipBtn = document.getElementById('flipBtn');
    const statusEl = document.getElementById('status');
    const hud = document.getElementById('hud');
    const toast = document.getElementById('toast');

    let stream = null;
    let usingFront = true;
    let running = false;
    let faceLandmarker = null;
    let lastT = performance.now(), fps = 0;

    const sunglassesImg = new Image();
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='300' viewBox='0 0 800 300'>
      <defs>
        <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop offset='0' stop-color='#111'/>
          <stop offset='1' stop-color='#333'/>
        </linearGradient>
        <filter id='shadow' x='-50%' y='-50%' width='200%' height='200%'>
          <feDropShadow dx='0' dy='6' stdDeviation='8' flood-color='rgba(0,0,0,0.6)'/>
        </filter>
      </defs>
      <g filter='url(#shadow)'>
        <rect x='380' y='110' width='40' height='20' rx='10' fill='url(#g)'/>
        <rect x='140' y='90' width='220' height='140' rx='24' fill='url(#g)' stroke='#000' stroke-width='6'/>
        <rect x='168' y='120' width='164' height='84' rx='16' fill='rgba(0,0,0,0.55)'/>
        <rect x='440' y='90' width='220' height='140' rx='24' fill='url(#g)' stroke='#000' stroke-width='6'/>
        <rect x='468' y='120' width='164' height='84' rx='16' fill='rgba(0,0,0,0.55)'/>
        <rect x='40' y='130' width='120' height='22' rx='11' fill='url(#g)'/>
        <rect x='640' y='130' width='120' height='22' rx='11' fill='url(#g)'/>
      </g>
    </svg>`;
    sunglassesImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);

    function setStatus(t){ statusEl.textContent = t; }
    function fitCanvas(){ canvas.width = video.videoWidth || canvas.clientWidth; canvas.height = video.videoHeight || canvas.clientHeight; }
    function showToast(msg, ms=1800){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'), ms); }

    async function loadModel(){
      if (faceLandmarker) return;
      setStatus('loading face model…');
      const {FilesetResolver, FaceLandmarker} = window;
      if (!FilesetResolver || !FaceLandmarker){
        setStatus('vision bundle failed to load');
        return;
      }
      const files = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm');
      faceLandmarker = await FaceLandmarker.createFromOptions(files,{
        baseOptions:{ modelAssetPath:'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/models/face_landmarker.task' },
        numFaces:1,
        runningMode:'VIDEO',
        outputFaceBlendshapes:false,
        outputFacialTransformationMatrixes:false
      });
      setStatus('model ready');
    }

    async function startCamera(front=true){
      stopCamera();
      usingFront = front;
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          audio:false, video:{ facingMode: front?'user':'environment', width:{ideal:1280}, height:{ideal:720} }
        });
        video.srcObject = stream;
        await video.play().catch(()=>{});
        fitCanvas();
        startBtn.classList.add('hidden');
        flipBtn.classList.remove('hidden');
        setStatus(front?'front camera':'rear camera');
        return true;
      }catch(e){
        console.warn('getUserMedia error', e);
        setStatus('tap Start and allow camera');
        startBtn.classList.remove('hidden');
        return false;
      }
    }
    function stopCamera(){ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }

    function drawGlasses(landmarks){
      const pts = landmarks[0];
      const LEFT_OUTER = 33, RIGHT_OUTER = 263, NOSE_BRIDGE = 6;
      const W = canvas.width, H = canvas.height;

      const l = pts[LEFT_OUTER], r = pts[RIGHT_OUTER], n = pts[NOSE_BRIDGE];
      // Mirror X because the displayed video is mirrored
      const lx = (1 - l.x)*W, ly = l.y*H;
      const rx = (1 - r.x)*W, ry = r.y*H;
      const nx = (1 - n.x)*W, ny = n.y*H;

      const cx = (lx + rx)/2;
      const cy = (ly + ry)/2;

      const dx = rx - lx, dy = ry - ly;
      const angle = Math.atan2(dy, dx);
      const eyeDist = Math.hypot(dx, dy);

      const width = eyeDist * 2.5;
      const height = width * (300/800);

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);
      ctx.drawImage(sunglassesImg, -width/2, -height*0.45, width, height);
      ctx.restore();
    }

    async function loop(){
      if (!running) return;
      if (video.readyState >= 2 && faceLandmarker){
        if (video.videoWidth !== canvas.width || video.videoHeight !== canvas.height) fitCanvas();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const now = performance.now();
        const res = faceLandmarker.detectForVideo(video, now);
        if (res && res.faceLandmarks && res.faceLandmarks.length){
          drawGlasses(res.faceLandmarks);
          setStatus('face tracked');
        }else{
          setStatus('searching for face…');
        }
        const dt = now - lastT; lastT = now; fps = Math.round(1000/dt);
        hud.textContent = `FPS ${fps}${usingFront?' • front':' • rear'}`;
      }
      requestAnimationFrame(loop);
    }

    startBtn.addEventListener('click', async ()=>{
      const ok = await startCamera(true);
      if (ok){
        await loadModel();
        running = true;
        loop();
      }
    });
    flipBtn.addEventListener('click', async ()=>{
      await startCamera(!usingFront);
    });
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopCamera(); else startCamera(usingFront); });

    // Try to auto-start (may be blocked on iOS until a tap)
    window.addEventListener('load', async ()=>{
      await loadModel();
      const ok = await startCamera(true);
      running = true;
      loop();
      if (!ok) showToast('Tap Start and allow camera');
    });

    window.addEventListener('resize', fitCanvas);
  })();
  </script>
</body>
</html>
