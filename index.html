<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sunglasses AR (Face Tracked)</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:8px 12px;background:rgba(0,0,0,.5);backdrop-filter:blur(6px)}
  header{display:flex;gap:8px;align-items:center}
  #stage{position:relative;overflow:hidden}
  #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .controls{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  button{appearance:none;padding:10px 14px;border-radius:999px;border:0;font-weight:600;background:#fff;color:#111;box-shadow:0 4px 16px rgba(0,0,0,.25);cursor:pointer}
  .badge{font-size:12px;opacity:.85}
  .hidden{display:none!important}
  .hud{position:absolute;top:8px;right:12px;font-size:12px;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1 style="font-size:16px;margin:0;">Sunglasses AR (Face Tracked)</h1>
      <div id="status" class="badge">loading…</div>
    </header>
    <div id="stage">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas"></canvas>
      <div class="hud" id="hud">—</div>
    </div>
    <footer>
      <div class="controls">
        <button id="startBtn">Start Camera</button>
        <button id="flipBtn" class="hidden">Flip Camera</button>
        <label class="badge"><input id="dbg" type="checkbox"> Debug landmarks</label>
        <span class="badge">Tip: allow camera access; good lighting helps.</span>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/vision_bundle_mediapipe.js" crossorigin="anonymous"></script>
  <script>
  (function(){
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const startBtn=document.getElementById('startBtn');
    const flipBtn=document.getElementById('flipBtn');
    const statusEl=document.getElementById('status');
    const hud=document.getElementById('hud');
    const dbg=document.getElementById('dbg');

    let stream=null, usingFront=true, running=false, faceLandmarker=null, lastT=performance.now();

    // Sunglasses vector as inline SVG → Image
    const sunglassesImg=new Image();
    const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='300' viewBox='0 0 800 300'>
      <defs>
        <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop offset='0' stop-color='#111'/><stop offset='1' stop-color='#333'/>
        </linearGradient>
        <filter id='shadow' x='-50%' y='-50%' width='200%' height='200%'>
          <feDropShadow dx='0' dy='6' stdDeviation='8' flood-color='rgba(0,0,0,0.6)'/>
        </filter>
      </defs>
      <g filter='url(#shadow)'>
        <rect x='380' y='110' width='40' height='20' rx='10' fill='url(#g)'/>
        <rect x='140' y='90' width='220' height='140' rx='24' fill='url(#g)' stroke='#000' stroke-width='6'/>
        <rect x='168' y='120' width='164' height='84' rx='16' fill='rgba(0,0,0,0.55)'/>
        <rect x='440' y='90' width='220' height='140' rx='24' fill='url(#g)' stroke='#000' stroke-width='6'/>
        <rect x='468' y='120' width='164' height='84' rx='16' fill='rgba(0,0,0,0.55)'/>
        <rect x='40' y='130' width='120' height='22' rx='11' fill='url(#g)'/>
        <rect x='640' y='130' width='120' height='22' rx='11' fill='url(#g)'/>
      </g>
    </svg>`;
    sunglassesImg.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg);

    function setStatus(t){ statusEl.textContent=t; }
    function fit(){ canvas.width=video.videoWidth||canvas.clientWidth; canvas.height=video.videoHeight||canvas.clientHeight; }

    async function loadModel(){
      if (faceLandmarker) return;
      const {FilesetResolver, FaceLandmarker} = window;
      const files = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm');
      faceLandmarker = await FaceLandmarker.createFromOptions(files,{
        baseOptions:{ modelAssetPath:'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/models/face_landmarker.task' },
        numFaces:1, runningMode:'VIDEO'
      });
      setStatus('model ready');
    }

    async function startCamera(front=true){
      stopCamera(); usingFront=front;
      try{
        stream = await navigator.mediaDevices.getUserMedia({audio:false, video:{facingMode:front?'user':'environment', width:{ideal:1280}, height:{ideal:720}}});
        video.srcObject=stream; await video.play().catch(()=>{});
        fit(); startBtn.classList.add('hidden'); flipBtn.classList.remove('hidden');
        setStatus(front?'front camera':'rear camera'); return true;
      }catch(e){ console.warn(e); setStatus('tap Start and allow camera'); startBtn.classList.remove('hidden'); return false; }
    }
    function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }

    function drawGlasses(landmarks){
      const pts=landmarks[0], L=33, R=263, W=canvas.width, H=canvas.height;
      const lx=(1-pts[L].x)*W, ly=pts[L].y*H, rx=(1-pts[R].x)*W, ry=pts[R].y*H;
      const cx=(lx+rx)/2, cy=(ly+ry)/2, dx=rx-lx, dy=ry-ly, angle=Math.atan2(dy,dx);
      const eyeDist=Math.hypot(dx,dy), width=eyeDist*2.5, height=width*(300/800);
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle); ctx.drawImage(sunglassesImg,-width/2,-height*0.45,width,height); ctx.restore();
      if (dbg.checked){ ctx.fillStyle='lime'; [[lx,ly],[rx,ry]].forEach(([x,y])=>{ctx.beginPath();ctx.arc(x,y,4,0,6.28);ctx.fill();}); }
    }

    async function loop(){
      if(!running) return;
      if(video.readyState>=2 && faceLandmarker){
        if(video.videoWidth!==canvas.width || video.videoHeight!==canvas.height) fit();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const now=performance.now(), res=faceLandmarker.detectForVideo(video, now);
        if(res && res.faceLandmarks && res.faceLandmarks.length){ drawGlasses(res.faceLandmarks); setStatus('face tracked'); }
        else{ setStatus('searching for face…'); }
        const dt=now-lastT; lastT=now; const fps=Math.max(1,Math.round(1000/Math.max(1,dt))); hud.textContent=`FPS ${fps}${usingFront?' • front':' • rear'}`;
      }
      requestAnimationFrame(loop);
    }

    startBtn.addEventListener('click', async ()=>{ const ok=await startCamera(true); if(ok){ await loadModel(); running=true; loop(); } });
    flipBtn.addEventListener('click', async ()=>{ await startCamera(!usingFront); });
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCamera(); else startCamera(usingFront); });
    window.addEventListener('resize', fit);

    // Attempt autostart
    window.addEventListener('load', async ()=>{ await loadModel(); const ok=await startCamera(true); running=true; loop(); if(!ok) setStatus('tap Start and allow camera'); });
  })();
  </script>
</body>
</html>
